trigger:
  branches:
    include:
      - main
  paths:
    include:
      - '/Pipelines/**'
resources:
  - repo: self

variables:
  # TODO: combine and simplify these variable groups
  - group: github-and-azure-access-tokens
  - group: service-principal-info
  - name: vmImageName
    value: 'ubuntu-latest'

stages:
  - stage: Build
    displayName: Build
    jobs:
      - job: Build
        displayName: Build
        pool:
          vmImage: $(vmImageName)
        steps:
          - script: |
              echo "Any build steps could go here."

  - stage: DeployAllPipelines
    displayName: Deploy all Pipelines
    dependsOn: Build

    jobs:
      - job: TerraformDeploy
        displayName: Terraform Deploy
        pool:
          vmImage: $(vmImageName)
        steps:
          - script: |
              cd Pipelines/PipelinesStack
              # TODO: simplify this
              echo '{
                "CdkTfBackendAzureResourceGroupName": "$(CdkTfBackendAzureResourceGroupName)",
                "CdkTfBackendAzureStorageAccountName": "$(CdkTfBackendAzureStorageAccountName)",
                "CdkTfBackendAzureStorageContainerName": "$(CdkTfBackendAzureStorageContainerName)",
                "AzureDevopsOrganizationUrl": "$(AzureDevopsOrganizationUrl)",
                "AzureDevopsPersonalAccessToken": "$(AzureDevopsPersonalAccessToken)",
                "GithubPersonalAccessToken": "$(GithubPersonalAccessToken)"
              }' > appsettings.json
            displayName: 'Populate appsettings.json'
          - script: |
              cd Pipelines/PipelinesStack
              dotnet build
              npm ci
              npm run deploy -- --auto-approve
            displayName: 'shell: cdktf deploy'
            env:
              ARM_CLIENT_ID: $(appId)
              ARM_CLIENT_SECRET: $(password)
              ARM_TENANT_ID: $(tenant)
              # TODO: make this dynamic/variable
              ARM_SUBSCRIPTION_ID: "c6b57d84-a545-465b-bf2f-037b6f4480a9"
#              AZURE_DEVOPS_EXT_PAT: $(System.AccessToken)
          - task: CmdLine@2
            displayName: 'Generate Pipeline yaml files'
            inputs:
              script: |
                cd Pipelines/PipelinesGenerator
                dotnet run
          - task: CmdLine@2
            displayName: 'Commit modified pipeline yaml files'
            inputs:
              script: |
                echo "TODO: need to commit modified yaml files"
                git status
                
                
